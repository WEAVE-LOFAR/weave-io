import logging
import sys
from time import sleep

from astropy.io import fits

from weaveio.opr3.l2files import L2File

logging.basicConfig(level=logging.INFO)
from weaveio.opr3 import Data

data = Data(dbname='lowleveltest2')
with data.write:
    data.graph.execute('match (n) where n.`_dbcreated` > 1653341395230 detach delete n')
#     runids = [1002209, 1002210, 1002211, 1002212, 1002213, 1002214, 1002215, 1002216, 1002217, 1002218, 1002219, 1002220, 1002221, 1002222, 1002223, 1002224, 1002225, 1002226, 1002227, 1002228, 1002229, 1002230, 1002231, 1002232, 1002233, 1002234, 1002235, 1002236, 1002237, 1002238, 1002239, 1002240, 1002241, 1002242, 1002243, 1002244, 1002245, 1002246, 1002247, 1002248, 1002249, 1002250, 1002251, 1002252, 1002253, 1002254, 1002255, 1002256, 1002257, 1002258, 1002259, 1002260, 1002261, 1002263, 1002264, 1002265, 1002266, 1002267, 1002268, 1002941, 1002942, 1002943, 1002944, 1002945, 1002946, 1002947, 1002948, 1002949, 1002950, 1002951, 1002952, 1002953, 1002954, 1002955, 1002956, 1002957, 1002958, 1002959, 1002960, 1002961, 1002962, 1002963, 1002964, 1002965, 1002966, 1002967, 1002968, 1002969, 1002970, 1002971, 1002972, 1002973, 1002974, 1002975, 1002976, 1002977, 1002978, 1002979, 1002980, 1002981, 1002982, 1002983, 1002984, 1002985, 1002986, 1002987, 1002988, 1002989, 1002990, 1002991, 1002992, 1002993, 1002994, 1002995, 1002996, 1002997, 1002998, 1002999, 1003000, 1003313, 1003314, 1003316, 1003319, 1003320, 1003322, 1003324, 1003325, 1003326, 1003327, 1003330, 1003333, 1003334, 1003337, 1003338, 1003339, 1003340, 1003341, 1003342, 1003343, 1003344, 1003346, 1003348, 1003350, 1003352, 1003353, 1003354, 1003355, 1003356, 1003358, 1003359, 1003360, 1003409, 1003410, 1003411, 1003412, 1003413, 1003414, 1003415, 1003416, 1003417, 1003418, 1003419, 1003420, 1003421, 1003422, 1003423, 1003424, 1003425, 1003426, 1003427, 1003428, 1003429, 1003430, 1003433, 1003434, 1003437, 1003438, 1003439, 1003440, 1003441, 1003442, 1003443, 1003444, 1003445, 1003446, 1003447, 1003448, 1003449, 1003450, 1003451, 1003452, 1003453, 1003454, 1003455, 1003456]
    fs = data.get_extant_files('l2file', return_only_fname=False)
#     # fs = data.find_files('l2single_file', 'l2stack_file', skip_extant_files=True)
#     # fs = [f for f in fs if any(str(runid) in f.name for runid in runids)]
#     # fs = [f for f in fs if all(runid in runids for runid in L2File.parser_ftypes_runids(fits.open(data.rootdir / f)[0].header)[1])]
#     # for f in fs:
#     #     print(f)
#     print(len(fs))
    data.write_files(*fs, debug=True, dryrun=False, batch_size=1, test_one=True, parts=['GAND'], halt_on_error=True)
